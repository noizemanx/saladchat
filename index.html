<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Sala de Chat con C치mara</title>

<style>
body { font-family: sans-serif; background: #222; color: #eee; padding: 20px; }
#chat { border: 1px solid #555; padding: 10px; height: 300px; overflow-y: scroll; background: #111; margin-top:10px;}
#videos { display: flex; gap: 10px; margin-top: 10px; }
video { width: 200px; border: 2px solid #444; border-radius:10px; }
button { margin-top:5px; }
</style>
</head>
<body>

<h2>游눫 Sala de Chat</h2>

<input type="text" id="nombre" placeholder="Tu nombre" />
<button onclick="entrar()">Entrar al chat</button>

<div id="chat" hidden></div>
<input id="mensaje" placeholder="Escribe algo..." hidden />
<button onclick="enviar()" hidden>Enviar</button>

<h3>游꿘 Tu c치mara</h3>
<button onclick="activarCamara()">Activar C치mara</button>

<div id="videos">
  <video id="localVideo" autoplay muted></video>
</div>

<div id="usuarios-activos" style="position:fixed; top:10px; left:10px; background:#000000a0; color:white; padding:10px; border-radius:10px;">
  <h4>游꿘 Usuarios con c치mara</h4>
  <ul id="lista-usuarios" style="list-style:none; padding:0;"></ul>
</div>

<button id="salirBtn" style="position: fixed; bottom: 20px; right: 20px; padding: 10px 20px; background: #c0392b; color: white; border: none; border-radius: 10px; cursor: pointer;">
游뛁 Salir
</button>

<script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>

<script>
let socket;
let nombreUsuario = "";
let localStream = null;

const chat = document.getElementById("chat");
const mensajeInput = document.getElementById("mensaje");

function entrar() {
  nombreUsuario = document.getElementById("nombre").value || "An칩nimo";

  document.getElementById("nombre").style.display = "none";
  document.querySelector("button").style.display = "none";

  chat.hidden = false;
  mensajeInput.hidden = false;
  document.querySelector("button[onclick='enviar()']").hidden = false;

  socket = io("https://saladchat.onrender.com");

  socket.emit("entrar", nombreUsuario);

  socket.on("mensaje", (data) => {
    chat.innerHTML += `<p><strong>${data.nombre}:</strong> ${data.texto}</p>`;
    chat.scrollTop = chat.scrollHeight;
  });

  socket.on("usuariosCamara", (lista) => {
    actualizarListaCamara(lista);
  });
}

function enviar() {
  const texto = mensajeInput.value;
  if (texto.trim() !== "") {
    socket.emit("mensaje", { nombre: nombreUsuario, texto });
    mensajeInput.value = "";
  }
}

async function activarCamara() {
  try {
    localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
    document.getElementById("localVideo").srcObject = localStream;
    socket.emit("camaraActivada", nombreUsuario);
  } catch (err) {
    alert("No se pudo activar la c치mara");
  }
}

function actualizarListaCamara(lista) {
  const ul = document.getElementById("lista-usuarios");
  ul.innerHTML = "";

  lista.forEach(user => {
    const li = document.createElement("li");
    li.innerHTML = `${user} 游닝`;
    ul.appendChild(li);
  });
}

document.getElementById("salirBtn").addEventListener("click", () => {
  if (socket) socket.disconnect();

  if (localStream) {
    localStream.getTracks().forEach(track => track.stop());
  }

  location.reload();
});
</script>

</body>
</html>
