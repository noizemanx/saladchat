<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Sala VideoChat</title>

<style>
body { font-family: sans-serif; background: #111; color: white; padding: 20px; }
#chat { height:200px; overflow-y:auto; background:#222; padding:10px; margin-top:10px;}
#videos { display:flex; flex-wrap:wrap; gap:10px; margin-top:15px;}
video { width:200px; border-radius:10px; background:black;}
button { margin-top:5px;}
</style>
</head>
<body>

<h2>ðŸŽ¥ Sala VideoChat</h2>

<input id="nombre" placeholder="Tu nombre"/>
<button onclick="entrar()">Entrar</button>
<button onclick="activarCamara()">Activar CÃ¡mara</button>

<div id="chat"></div>
<input id="mensaje" placeholder="Mensaje..."/>
<button onclick="enviar()">Enviar</button>

<div id="videos">
  <video id="localVideo" autoplay muted></video>
</div>

<script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>

<script>
let socket;
let localStream;
let peers = {};
let nombreUsuario;

function entrar() {
  nombreUsuario = document.getElementById("nombre").value || "AnÃ³nimo";

  socket = io("https://saladchat.onrender.com");

  socket.emit("join-room", nombreUsuario);

  socket.on("mensaje", (data) => {
    document.getElementById("chat").innerHTML += 
      `<p><strong>${data.nombre}:</strong> ${data.texto}</p>`;
  });

  socket.on("user-connected", (user) => {
    createPeer(user.id, true);
  });

  socket.on("signal", async (data) => {
    if (!peers[data.from]) {
      createPeer(data.from, false);
    }

    if (data.signal.type) {
      await peers[data.from].setRemoteDescription(
        new RTCSessionDescription(data.signal)
      );

      if (data.signal.type === "offer") {
        const answer = await peers[data.from].createAnswer();
        await peers[data.from].setLocalDescription(answer);

        socket.emit("signal", {
          to: data.from,
          signal: answer
        });
      }
    } else {
      await peers[data.from].addIceCandidate(
        new RTCIceCandidate(data.signal)
      );
    }
  });

  socket.on("user-disconnected", (id) => {
    if (peers[id]) {
      peers[id].close();
      delete peers[id];
      document.getElementById(id)?.remove();
    }
  });
}

function enviar() {
  const texto = document.getElementById("mensaje").value;
  socket.emit("mensaje", { nombre: nombreUsuario, texto });
  document.getElementById("mensaje").value = "";
}

async function activarCamara() {
  localStream = await navigator.mediaDevices.getUserMedia({
    video: true,
    audio: true
  });

  document.getElementById("localVideo").srcObject = localStream;
}

function createPeer(id, initiator) {
  const peer = new RTCPeerConnection({
    iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
  });

  if (localStream) {
    localStream.getTracks().forEach(track => {
      peer.addTrack(track, localStream);
    });
  }

  peer.onicecandidate = event => {
    if (event.candidate) {
      socket.emit("signal", {
        to: id,
        signal: event.candidate
      });
    }
  };

  peer.ontrack = event => {
    let video = document.getElementById(id);
    if (!video) {
      video = document.createElement("video");
      video.id = id;
      video.autoplay = true;
      document.getElementById("videos").appendChild(video);
    }
    video.srcObject = event.streams[0];
  };

  if (initiator) {
    peer.createOffer().then(offer => {
      peer.setLocalDescription(offer);
      socket.emit("signal", {
        to: id,
        signal: offer
      });
    });
  }

  peers[id] = peer;
}
</script>

</body>
</html>
