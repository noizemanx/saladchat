<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Sala VideoChat</title>

<style>
* {
  box-sizing: border-box;
}

body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: black;
  color: white;
  height: 100vh;
  overflow: hidden;
}

/* CONTENEDOR VIDEO FULL */
#videos {
  position: absolute;
  inset: 0;
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 5px;
  padding: 5px;
}

video {
  width: 100%;
  height: 100%;
  object-fit: cover;
  border-radius: 10px;
  cursor: pointer;
  transition: 0.3s ease;
}

video.grande {
  grid-column: 1 / -1;
  grid-row: 1 / -1;
  z-index: 2;
}

/* CONTROLES SUPERIORES */
header {
  position: absolute;
  top: 10px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 5;
  display: flex;
  gap: 8px;
  background: rgba(0,0,0,0.4);
  padding: 8px 12px;
  border-radius: 12px;
  backdrop-filter: blur(6px);
}

input, button {
  padding: 6px 10px;
  border-radius: 6px;
  border: none;
  outline: none;
}

button {
  background: #2563eb;
  color: white;
  cursor: pointer;
}

button:hover {
  background: #1d4ed8;
}

/* CHAT FLOTANTE */
#chatContainer {
  position: absolute;
  bottom: 20px;
  left: 20px;
  width: 300px;
  max-height: 40vh;
  display: flex;
  flex-direction: column;
  z-index: 5;
}

#chat {
  flex: 1;
  overflow-y: auto;
  padding: 10px;
  font-size: 14px;
  background: rgba(0,0,0,0.3);
  border-radius: 12px;
  backdrop-filter: blur(6px);
}

#chat p {
  margin: 4px 0;
}

#chat strong {
  color: #38bdf8;
}

#chatInputArea {
  display: flex;
  margin-top: 5px;
  gap: 5px;
}

#mensaje {
  flex: 1;
}
</style>
</head>

<body>

<header>
  <input id="nombre" placeholder="Tu nombre"/>
  <button id="btnEntrar">Entrar</button>
  <button id="btnCamara">Activar C치mara</button>
  <button id="btnMic">Mutear Mic</button>
</header>

<div id="videos">
  <video id="localVideo" autoplay muted playsinline></video>
</div>

<div id="chatContainer">
  <div id="chat"></div>
  <div id="chatInputArea">
    <input id="mensaje" placeholder="Mensaje..."/>
    <button id="btnEnviar">Enviar</button>
  </div>
</div>

<script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>

<script>
let socket;
let localStream = null;
let peers = {};
let nombreUsuario;
let usuariosPendientes = [];
let micActivo = true;

const btnEntrar = document.getElementById("btnEntrar");
const btnCamara = document.getElementById("btnCamara");
const btnEnviar = document.getElementById("btnEnviar");
const btnMic = document.getElementById("btnMic");

btnEntrar.onclick = entrar;
btnCamara.onclick = activarCamara;
btnEnviar.onclick = enviar;
btnMic.onclick = toggleMic;

function entrar() {
  nombreUsuario = document.getElementById("nombre").value || "An칩nimo";

  socket = io("https://saladchat.onrender.com", {
    transports: ["websocket"]
  });

  socket.emit("join-room", nombreUsuario);

  socket.on("mensaje", (data) => {
    document.getElementById("chat").innerHTML += 
      `<p><strong>${data.nombre}:</strong> ${data.texto}</p>`;
  });

  socket.on("user-connected", (user) => {
    if (localStream) {
      createPeer(user.id, true);
    } else {
      usuariosPendientes.push(user.id);
    }
  });

  socket.on("signal", async (data) => {
    if (!peers[data.from]) {
      createPeer(data.from, false);
    }

    if (data.signal.type) {
      await peers[data.from].setRemoteDescription(
        new RTCSessionDescription(data.signal)
      );

      if (data.signal.type === "offer") {
        const answer = await peers[data.from].createAnswer();
        await peers[data.from].setLocalDescription(answer);

        socket.emit("signal", {
          to: data.from,
          signal: answer
        });
      }
    } else {
      await peers[data.from].addIceCandidate(
        new RTCIceCandidate(data.signal)
      );
    }
  });

  socket.on("user-disconnected", (id) => {
    if (peers[id]) {
      peers[id].close();
      delete peers[id];
      document.getElementById(id)?.remove();
    }
  });

  btnEntrar.disabled = true;
}

function enviar() {
  const texto = document.getElementById("mensaje").value;
  if (!texto) return;

  socket.emit("mensaje", { nombre: nombreUsuario, texto });
  document.getElementById("mensaje").value = "";
}

async function activarCamara() {
  try {
    localStream = await navigator.mediaDevices.getUserMedia({
      video: true,
      audio: true
    });

    document.getElementById("localVideo").srcObject = localStream;

    usuariosPendientes.forEach(id => {
      createPeer(id, true);
    });

    usuariosPendientes = [];

  } catch (error) {
    console.error(error);
    alert("Error activando c치mara o micr칩fono");
  }
}

function toggleMic() {
  if (!localStream) return;

  localStream.getAudioTracks().forEach(track => {
    track.enabled = !track.enabled;
    micActivo = track.enabled;
  });

  btnMic.textContent = micActivo ? "Mutear Mic" : "Activar Mic";
}

function createPeer(id, initiator) {
  const peer = new RTCPeerConnection({
    iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
  });

  localStream.getTracks().forEach(track => {
    peer.addTrack(track, localStream);
  });

  peer.onicecandidate = event => {
    if (event.candidate) {
      socket.emit("signal", {
        to: id,
        signal: event.candidate
      });
    }
  };

  peer.ontrack = event => {
    let video = document.getElementById(id);
    if (!video) {
      video = document.createElement("video");
      video.id = id;
      video.autoplay = true;
      video.playsInline = true;
      video.onclick = () => {
        video.classList.toggle("grande");
      };
      document.getElementById("videos").appendChild(video);
    }
    video.srcObject = event.streams[0];
  };

  if (initiator) {
    peer.createOffer().then(offer => {
      peer.setLocalDescription(offer);
      socket.emit("signal", {
        to: id,
        signal: offer
      });
    });
  }

  peers[id] = peer;
}
</script>

</body>
</html>

